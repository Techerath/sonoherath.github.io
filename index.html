<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voli con Herath - Aviazione Premium</title>
    <style>
        /* AGGIORNAMENTO STILE PER IL PLAYER */
        #music-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            gap: 10px;
        }
        
        #music-toggle {
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid #ffd700;
            transition: all 0.3s;
        }
        
        #music-toggle.active {
            background: #0066cc;
        }
        
        #music-status {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transform: translateX(20px);
            opacity: 0;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        #music-container:hover #music-status {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <!-- AGGIUNGI QUESTO DIV PER IL CONTROLLO MUSICA -->
    <div id="music-container">
        <div id="music-toggle" title="Controllo musica">
            <i class="fas fa-music"></i>
        </div>
        <div id="music-status">Musica: Disattivata</div>
    </div>

    <!-- IL RESTO DEL TUO HTML... -->

    <!-- MODIFICA IL PLAYER YOUTUBE IN QUESTO MODO -->
    <div id="youtube-music"></div>

    <script>
        // 1. VARIABILI GLOBALI AGGIORNATE
        let player;
        let musicEnabled = false;
        let playerReady = false;
        let currentView = 'home';
        
        // 2. FUNZIONE PER CARICARE LO SCRIPT YOUTUBE
        function loadYouTubeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        
        // 3. INIZIALIZZA IL PLAYER IN MODO PIÙ ROBUSTO
        function initYouTubePlayer() {
            player = new YT.Player('youtube-music', {
                height: '0',
                width: '0',
                videoId: '6OhGIif_-R8',
                playerVars: {
                    'autoplay': 0,
                    'loop': 1,
                    'playlist': '6OhGIif_-R8',
                    'controls': 0,
                    'disablekb': 1,
                    'enablejsapi': 1,
                    'fs': 0,
                    'rel': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }
        
        // 4. GESTIONE EVENTI AGGIORNATA
        function onPlayerReady(event) {
            playerReady = true;
            event.target.setVolume(30);
            updateMusicStatus();
            
            // Attiva la musica solo dopo interazione utente
            document.addEventListener('click', firstUserInteraction, { once: true });
        }
        
        function firstUserInteraction() {
            if (currentView === 'home') {
                toggleMusic(true);
            }
        }
        
        function onPlayerStateChange(event) {
            // Nuova gestione degli stati
            if (event.data === YT.PlayerState.ENDED) {
                player.playVideo(); // Riproduci di nuovo se finisce
            }
        }
        
        function onPlayerError(event) {
            console.error('Errore YouTube Player:', event.data);
            // Tentativo di ricaricare il player dopo 5 secondi
            setTimeout(() => {
                if (player) {
                    player.destroy();
                }
                initYouTubePlayer();
            }, 5000);
        }
        
        // 5. FUNZIONI DI CONTROLLO MIGLIORATE
        function toggleMusic(enable) {
            if (!playerReady) return;
            
            musicEnabled = enable;
            
            try {
                if (enable) {
                    player.playVideo();
                } else {
                    player.pauseVideo();
                }
                updateMusicStatus();
            } catch (e) {
                console.error("Errore nel controllo musica:", e);
                // Ripristina il player se c'è un errore
                playerReady = false;
                initYouTubePlayer();
            }
        }
        
        function updateMusicStatus() {
            const toggleBtn = document.getElementById('music-toggle');
            const statusText = document.getElementById('music-status');
            
            if (musicEnabled) {
                toggleBtn.classList.add('active');
                statusText.textContent = "Musica: Attiva";
            } else {
                toggleBtn.classList.remove('active');
                statusText.textContent = "Musica: Disattivata";
            }
        }
        
        // 6. GESTIONE PAGINE CON CONTROLLO ERRORI
        function showView(viewName) {
            try {
                // Nascondi tutte le view
                document.querySelectorAll('[data-view]').forEach(view => {
                    view.style.display = 'none';
                });
                
                // Mostra la view richiesta
                document.querySelector(`[data-view="${viewName}"]`).style.display = 'block';
                currentView = viewName;
                
                // Gestisci la musica in base alla view
                if (playerReady) {
                    if (viewName === 'home') {
                        toggleMusic(musicEnabled);
                    } else {
                        toggleMusic(false);
                    }
                }
            } catch (e) {
                console.error("Errore nel cambio view:", e);
            }
        }
        
        // 7. INIZIALIZZAZIONE AL CARICAMENTO
        window.addEventListener('DOMContentLoaded', () => {
            loadYouTubeAPI();
            
            // Controllo manuale musica
            document.getElementById('music-toggle').addEventListener('click', () => {
                toggleMusic(!musicEnabled);
            });
            
            // Gestione navigazione (esempio)
            document.querySelector('.story-link').addEventListener('click', (e) => {
                e.preventDefault();
                showView('story');
            });
            
            document.querySelector('.home-link').addEventListener('click', (e) => {
                e.preventDefault();
                showView('home');
            });
            
            document.querySelector('.back-home-btn').addEventListener('click', (e) => {
                e.preventDefault();
                showView('home');
            });
        });
        
        // 8. RIPRISTINO AUTOMATICO IN CASO DI PROBLEMI
        setInterval(() => {
            if (playerReady && !player.getPlayerState) {
                console.log("Player non risponde, reinizializzazione...");
                playerReady = false;
                initYouTubePlayer();
            }
        }, 30000); // Controlla ogni 30 secondi
    </script>
</body>
</html>